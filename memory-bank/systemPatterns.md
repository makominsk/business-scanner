# System Patterns: Бизнес-сканер MVP

**Архитектура (высокоуровнево):**
- **UI слой (клиент):** Next.js React-компоненты (`app/page.tsx`) для формы поиска, отображения прогресса и результатов. Использует `shadcn/ui` для стилизации.
- **API слой (server routes):** Next.js API Routes (`/api/scan/route.ts`) для оркестрации всего процесса. Принимает запросы от клиента, валидирует их, запускает цепочку обработки данных и стримит прогресс.
- **Сервисный слой (`lib/`):** Чистые TypeScript-функции, инкапсулирующие бизнес-логику и взаимодействие с внешними API. Эти модули не зависят от UI или HTTP-контекста, что облегчает их тестирование.
- **Инфраструктурный слой:** Конфигурация, логгер, rate-limiter, обработка ошибок.

**Ключевые технические решения:**
- **Full-stack Next.js:** Использование App Router для унифицированной разработки UI и API.
- **TypeScript:** Строгая типизация для повышения надежности и поддерживаемости кода.
- **Zod:** Для валидации входных данных и обеспечения соответствия JSON-схемам.
- **Bottleneck:** Для управления параллелизмом и соблюдения квот внешних API.
- **Server-Sent Events (SSE) / WebSockets:** Для стриминга прогресса от сервера к клиенту.

**Дизайн-паттерны в использовании:**
- **Service Layer:** Разделение бизнес-логики на отдельные сервисы (`local-business-api`, `scraper`, `normalizer`, `google-sheets`).
- **Dependency Injection:** Передача зависимостей (например, API-клиентов) в сервисные функции для облегчения мокирования и тестирования.
- **Orchestration Pattern:** API-эндпоинт `/api/scan` выступает в роли оркестратора, координирующего вызовы различных сервисов.

**Взаимосвязи компонентов:**
- `app/page.tsx` (клиент) -> `/api/scan/route.ts` (API-слой)
- `/api/scan/route.ts` -> `lib/local-business-api.ts` (RapidAPI)
- `/api/scan/route.ts` -> `lib/scraper.ts` (Парсинг сайтов)
- `/api/scan/route.ts` -> `lib/normalizer.ts` (Gemini API)
- `/api/scan/route.ts` -> `lib/google-sheets.ts` (Google Sheets API)
- `lib/schemas.ts` используется на всех слоях для валидации данных.

**Критические пути реализации:**
1.  **Обработка запроса:** Валидация входных данных, инициализация Job ID.
2.  **Поиск бизнесов:** Вызов RapidAPI, обработка пагинации и лимитов.
3.  **Детализация и скрейпинг:** Параллельный вызов деталей и скрейпинг сайтов для каждого бизнеса с троттлингом.
4.  **Нормализация:** Отправка сырых данных в Gemini с JSON-схемой, обработка ошибок нормализации.
5.  **Запись в Google Sheets:** Батчевая запись результатов, обработка ошибок записи.
6.  **Обновление прогресса:** Передача статуса выполнения на клиент.

**Модель данных (BusinessRecord):**
- `source`, `collected_at`, `region_query`, `activity_query`
- `place_id`, `name`, `categories`, `description?`, `address_full`, `address_components`, `location`, `phone_e164?`, `website?`, `emails[]`, `socials{}`
- `rating?`, `user_ratings_total?`, `opening_hours_raw[]?`, `price_level?`, `google_url?`, `notes?`
